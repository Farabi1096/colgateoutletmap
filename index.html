<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlet Tracker - Bangladesh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        colgate: {
                            red: '#E01933',
                            dark: '#8E0016',
                            blue: '#002169',
                            lightBlue: '#E6F0FA',
                        }
                    },
                    fontFamily: {
                        sans: ['"Open Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom CSS for layout and map container */
        body {
            background-color: #F3F4F6;
            color: #4B5563;
        }
        
        /* Map Styles */
        #map {
            height: 550px; 
            width: 100%;
            border-radius: 1rem;
            z-index: 1;
            background: #e5e7eb; 
        }

        /* Minimalistic Input Styles */
        .min-input {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            transition: all 0.2s ease;
        }
        .min-input:focus {
            background-color: #FFFFFF;
            border-color: #E01933;
            outline: none;
            box-shadow: 0 0 0 1px #E01933;
        }

        /* Custom Scrollbar (Red Theme) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .leaflet-control-container {
            visibility: hidden;
        }
        
        .invalid-list-item {
            border-left: 3px solid #E01933;
            background-color: #FFF1F2;
        }

        /* KPI Card Styling */
        .kpi-card {
            background: white;
            border: 1px solid #F3F4F6;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .kpi-red::before { background-color: #E01933; }
        .kpi-blue::before { background-color: #002169; }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
        }

        /* Checkbox Styling for Routes */
        .route-checkbox:checked + div {
            background-color: #E01933;
            border-color: #E01933;
        }
        .route-checkbox:checked + div svg {
            display: block;
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start py-8 px-4 md:px-6">

    <!-- Main Container -->
    <div class="w-full max-w-6xl fade-in grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">
        
        <!-- Header -->
        <div class="lg:col-span-12 mb-2 flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-colgate-red tracking-tight leading-none">
                    LOCATION<span class="text-colgate-blue">TRACKER</span>
                </h1>
                <p class="text-xs text-gray-500 font-semibold uppercase tracking-wide mt-1">Bangladesh Retail Mapping</p>
            </div>
             <div id="system-status" class="hidden md:flex items-center gap-2 px-3 py-1 bg-white rounded-full border border-gray-200 shadow-sm">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span class="text-xs font-bold text-gray-600">Local DB</span>
            </div>
        </div>

        <!-- Left Column: Controls (Inputs & Filters) -->
        <div class="lg:col-span-3 flex flex-col gap-4 h-full">

            <!-- Filters Section -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 shrink-0 relative z-50">
                <h2 class="text-gray-800 font-bold text-sm mb-3 flex items-center gap-2 uppercase tracking-wide">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-colgate-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Filters
                </h2>
                
                <div class="space-y-3">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search..." class="min-input w-full pl-8 p-2 rounded-lg text-xs font-medium">
                        <svg class="w-3 h-3 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    
                    <select id="filter-area" class="min-input w-full p-2 rounded-lg text-xs text-gray-600"><option value="">All Areas</option></select>
                    <select id="filter-territory" class="min-input w-full p-2 rounded-lg text-xs text-gray-600"><option value="">All Territories</option></select>
                    <select id="filter-town" class="min-input w-full p-2 rounded-lg text-xs text-gray-600"><option value="">All Towns</option></select>
                    
                    <!-- NEW MULTI-SELECT ROUTE FILTER -->
                    <div class="relative">
                        <button id="route-multiselect-btn" class="min-input w-full p-2 rounded-lg text-xs text-gray-600 text-left flex justify-between items-center bg-white cursor-pointer">
                            <span id="route-btn-text" class="truncate">All Routes</span>
                            <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <!-- Dropdown Content -->
                        <div id="route-dropdown-list" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto p-2 custom-scrollbar">
                            <!-- JS will populate checkboxes here -->
                            <div class="text-xs text-gray-400 text-center py-2">Select Town first</div>
                        </div>
                    </div>
                    
                    <button id="clear-filters-btn" class="w-full text-[10px] text-gray-400 hover:text-colgate-red transition-colors font-bold uppercase tracking-wider py-1 border-t border-dashed border-gray-200 mt-2">
                        Reset All
                    </button>
                    
                    <!-- NEW: Reset Data Button -->
                    <button id="clear-all-data-btn" class="w-full text-[10px] text-red-300 hover:text-red-500 transition-colors font-bold uppercase tracking-wider py-1 mt-4">
                        Clear Saved Data
                    </button>
                </div>
            </div>
            
            <!-- CSV Upload Section -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 flex-1 flex flex-col z-0">
                <h2 class="text-gray-800 font-bold text-sm mb-3 flex items-center gap-2 uppercase tracking-wide shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-colgate-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Data Import
                </h2>
                
                <div class="flex-1 flex flex-col justify-center">
                    <label class="block w-full cursor-pointer hover:bg-gray-50 transition-colors border border-dashed border-gray-300 rounded-lg p-6 text-center h-full flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-xs font-semibold text-gray-500">Click to Select CSV</span>
                        <input type="file" id="csv-upload" accept=".csv" class="hidden"/>
                    </label>
                    <div id="file-name-display" class="hidden text-[10px] text-colgate-blue font-bold mt-2 text-center truncate"></div>

                    <button id="upload-csv-btn" class="w-full mt-3 bg-colgate-blue text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-900 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-md shadow-blue-100" disabled>
                        UPLOAD DATA
                    </button>
                    <p id="upload-status" class="text-[10px] mt-2 text-center text-gray-400 font-medium shrink-0">Req: Lat, Lng, Route, Outlet Name</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Map & Info -->
        <div class="lg:col-span-9 flex flex-col gap-4 h-full">

            <!-- Top Row: Status Card & KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
                
                <!-- Status/Info Card -->
                <div id="info-card" class="bg-colgate-blue rounded-xl p-4 text-white shadow-md flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-white/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <h3 id="card-title" class="font-bold text-sm relative z-10">Welcome</h3>
                    <p id="card-detail" class="text-blue-100 text-xs opacity-80 mt-1 relative z-10 truncate">
                        Large Data Mode Ready
                    </p>
                </div>
                
                <!-- KPI 1: Active Outlets -->
                <div class="kpi-card kpi-red rounded-xl p-4 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total Outlets</p>
                        <h4 id="kpi-outlets" class="text-2xl font-extrabold text-gray-800 mt-0.5">0</h4>
                    </div>
                    <div class="h-8 w-8 bg-red-50 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-colgate-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </div>

                <!-- KPI 2: Route Coverage -->
                <div class="kpi-card kpi-blue rounded-xl p-4 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Route Coverage</p>
                        <h4 id="kpi-distance" class="text-2xl font-extrabold text-gray-800 mt-0.5">0 <span class="text-xs font-semibold text-gray-400">km</span></h4>
                    </div>
                    <div class="h-8 w-8 bg-blue-50 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-colgate-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="relative group rounded-xl overflow-hidden shadow-lg border-2 border-white flex-1 flex flex-col">
                <div id="map" class="flex-1"></div>
                <!-- Controls overlay -->
                <div class="absolute bottom-4 left-4 z-[400] bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-lg border border-gray-100 shadow-sm text-[10px] text-gray-500 font-bold tracking-wider pointer-events-none">
                    OUTLET MAPPER v1.0
                </div>
            </div>

        </div>

        <!-- Invalid/Outside Region Section -->
        <div id="invalid-box" class="lg:col-span-12 hidden bg-white border border-red-100 rounded-xl p-4 shadow-sm mt-2">
            <div class="flex items-center gap-3 mb-3 border-b border-red-100 pb-2">
                <div class="h-8 w-8 bg-red-50 rounded-full flex items-center justify-center shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-colgate-red" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <h3 id="invalid-header" class="text-colgate-red font-bold text-sm uppercase tracking-wide">Data Anomalies</h3>
                    <p class="text-[10px] text-gray-500">Outlets with coordinates outside Bangladesh (Lat: 20-29, Lng: 86-95)</p>
                </div>
            </div>
            
            <!-- Horizontal Scrolling List -->
            <div id="invalid-list" class="flex gap-3 overflow-x-auto custom-scrollbar pb-2">
                <!-- List items will be injected here -->
            </div>
        </div>

    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Application Logic (IndexedDB for Large Data) -->
    <script>
        // --- INDEXED DB SETUP ---
        const DB_NAME = 'OutletTrackerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'outlets';

        let dbPromise = null;
        let map;
        let markerLayer = L.layerGroup(); 
        let polylineLayer = L.layerGroup();
        let allOutlets = [];
        let selectedRoutes = new Set(); 

        const infoCard = document.getElementById('info-card');
        const cardTitle = document.getElementById('card-title');
        const cardDetail = document.getElementById('card-detail');
        
        const invalidBox = document.getElementById('invalid-box');
        const invalidList = document.getElementById('invalid-list');
        const invalidHeader = document.getElementById('invalid-header'); 

        const searchInput = document.getElementById('search-input');
        const filterArea = document.getElementById('filter-area');
        const filterTerritory = document.getElementById('filter-territory');
        const filterTown = document.getElementById('filter-town');
        
        const routeBtn = document.getElementById('route-multiselect-btn');
        const routeList = document.getElementById('route-dropdown-list');
        const routeBtnText = document.getElementById('route-btn-text');
        
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const clearDataBtn = document.getElementById('clear-all-data-btn');
        
        const csvUpload = document.getElementById('csv-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const uploadCsvBtn = document.getElementById('upload-csv-btn');
        const uploadStatus = document.getElementById('upload-status');

        const kpiOutlets = document.getElementById('kpi-outlets');
        const kpiDistance = document.getElementById('kpi-distance');

        // --- 1. DB HELPER FUNCTIONS ---

        const openDatabase = () => {
            if (dbPromise) return dbPromise;

            dbPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        // KeyPath auto-increment allows storing mostly anything, though we could use an ID
                        db.createObjectStore(STORE_NAME, { autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    reject("Database error: " + event.target.errorCode);
                };
            });
            return dbPromise;
        };

        const saveDataToIDB = async (newRecords) => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);

                // Use transaction oncomplete for large batch performance
                transaction.oncomplete = () => {
                    resolve();
                };
                transaction.onerror = (e) => reject(e);

                newRecords.forEach(record => {
                    store.add(record);
                });
            });
        };

        const loadDataFromIDB = async () => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = (e) => reject(e);
            });
        };

        const clearDataFromIDB = async () => {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        };

        // --- 2. DATA MANAGEMENT ---

        const loadData = async () => {
            try {
                cardDetail.textContent = "Loading data from database...";
                allOutlets = await loadDataFromIDB();
                
                if (allOutlets.length > 0) {
                    cardTitle.textContent = "Data Loaded";
                    cardDetail.textContent = `${allOutlets.length.toLocaleString()} records active.`;
                    
                    // Populate Filters
                    const areas = new Set(allOutlets.map(d => d.area_name).filter(Boolean));
                    updateSelect(filterArea, areas, filterArea.value);
                    updateCascadingFilters(0);
                } else {
                    cardTitle.textContent = "Welcome";
                    cardDetail.textContent = "No data found. Upload a CSV to begin.";
                }
            } catch (e) {
                console.error("IDB Error", e);
                cardTitle.textContent = "Error";
                cardDetail.textContent = "Could not load local database.";
            }
        };

        const clearAllData = async () => {
            if(confirm("Are you sure you want to delete ALL data? This cannot be undone.")) {
                try {
                    await clearDataFromIDB();
                    allOutlets = [];
                    applyLocalFilters();
                    cardTitle.textContent = "Cleared";
                    cardDetail.textContent = "All data has been removed.";
                    window.location.reload();
                } catch (e) {
                    alert("Failed to clear data.");
                }
            }
        }

        // --- 3. MAP LOGIC ---

        const initMap = () => {
            if (typeof L === 'undefined') {
                document.getElementById('map').innerHTML = '<div class="text-center text-red-500 p-8 text-xs">Map service failed.</div>';
                return; 
            }

            const southWest = L.latLng(18.0, 86.0); 
            const northEast = L.latLng(29.0, 95.0);
            const bounds = L.latLngBounds(southWest, northEast);

            map = L.map('map', {
                center: [23.8103, 90.4125],
                zoom: 7,
                minZoom: 6,
                maxBounds: bounds,
                maxBoundsViscosity: 0.8,
                zoomControl: false 
            });
            
            L.control.zoom({ position: 'topright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(map); 

            markerLayer.addTo(map); 
            polylineLayer.addTo(map);

            document.querySelector('.leaflet-control-container').style.visibility = 'visible';
            
            loadData(); // Load data after map init
        };

        // --- 4. FILTER LOGIC ---

        const updateSelect = (selectElement, values, currentValue) => {
            const oldVal = currentValue || selectElement.value;
            const firstOption = selectElement.options[0];
            selectElement.innerHTML = '';
            selectElement.appendChild(firstOption);

            Array.from(values).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });

            if (values.has(oldVal)) selectElement.value = oldVal;
            else selectElement.value = "";
        };

        const updateRouteMultiSelect = (routesSet) => {
            routeList.innerHTML = '';
            selectedRoutes.clear();
            routeBtnText.textContent = "All Routes";

            if (routesSet.size === 0) {
                routeList.innerHTML = '<div class="text-xs text-gray-400 text-center py-2">No routes found</div>';
                return;
            }

            const sortedRoutes = Array.from(routesSet).sort();

            sortedRoutes.forEach(route => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-2 hover:bg-gray-50 cursor-pointer rounded';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'route-checkbox hidden'; 
                input.value = route;
                
                const customCheck = document.createElement('div');
                customCheck.className = 'w-4 h-4 border border-gray-300 rounded flex items-center justify-center bg-white transition-colors';
                customCheck.innerHTML = `<svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;

                const span = document.createElement('span');
                span.className = 'text-xs text-gray-700';
                span.textContent = route;

                label.appendChild(input);
                label.appendChild(customCheck);
                label.appendChild(span);
                
                input.addEventListener('change', (e) => {
                    if (e.target.checked) selectedRoutes.add(e.target.value);
                    else selectedRoutes.delete(e.target.value);
                    
                    if (selectedRoutes.size === 0) routeBtnText.textContent = "All Routes";
                    else if (selectedRoutes.size === 1) routeBtnText.textContent = Array.from(selectedRoutes)[0];
                    else routeBtnText.textContent = `${selectedRoutes.size} Routes Selected`;
                    
                    applyLocalFilters();
                });

                routeList.appendChild(label);
            });
        };

        const updateCascadingFilters = (changedLevel) => {
            const fArea = filterArea.value;
            const fTerritory = filterTerritory.value;
            const fTown = filterTown.value;

            if (changedLevel <= 0) {
                let areaOutlets = allOutlets;
                if (fArea) areaOutlets = areaOutlets.filter(d => d.area_name === fArea);
                const territories = new Set(areaOutlets.map(d => d.territory_name).filter(Boolean));
                updateSelect(filterTerritory, territories, filterTerritory.value);
            }

            if (changedLevel <= 1) {
                let townOutlets = allOutlets;
                if (filterArea.value) townOutlets = townOutlets.filter(d => d.area_name === filterArea.value);
                if (filterTerritory.value) townOutlets = townOutlets.filter(d => d.territory_name === filterTerritory.value);
                
                const towns = new Set(townOutlets.map(d => d.town_name).filter(Boolean));
                updateSelect(filterTown, towns, filterTown.value);
            }

            if (changedLevel <= 2) {
                let routeOutlets = allOutlets;
                if (filterArea.value) routeOutlets = routeOutlets.filter(d => d.area_name === filterArea.value);
                if (filterTerritory.value) routeOutlets = routeOutlets.filter(d => d.territory_name === filterTerritory.value);
                if (filterTown.value) routeOutlets = routeOutlets.filter(d => d.town_name === filterTown.value);

                const routes = new Set(routeOutlets.map(d => d.route).filter(Boolean));
                updateRouteMultiSelect(routes); 
            }

            applyLocalFilters();
        };

        const applyLocalFilters = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const fArea = filterArea.value;
            const fTerritory = filterTerritory.value;
            const fTown = filterTown.value;

            const filteredData = allOutlets.filter(item => {
                if (fArea && item.area_name !== fArea) return false;
                if (fTerritory && item.territory_name !== fTerritory) return false;
                if (fTown && item.town_name !== fTown) return false;
                
                if (selectedRoutes.size > 0 && !selectedRoutes.has(item.route)) return false;

                if (searchTerm) {
                    const searchString = `${item.outletName} ${item.route} ${item.outlet_code || ''} ${item.town_name || ''}`.toLowerCase();
                    if (!searchString.includes(searchTerm)) return false;
                }
                return true;
            });

            const validMapData = [];
            const invalidListData = [];

            filteredData.forEach(item => {
                if (item.lat >= 20 && item.lat <= 29 && item.lng >= 86 && item.lng <= 95) {
                    validMapData.push(item);
                } else {
                    invalidListData.push(item);
                }
            });

            renderMarkers(validMapData);
            renderInvalidList(invalidListData);
        };

        const renderMarkers = (dataToRender) => {
            markerLayer.clearLayers(); 
            polylineLayer.clearLayers(); 
            
            kpiOutlets.textContent = dataToRender.length.toLocaleString();

            // Render limit to prevent browser crash with 20k markers
            // Only render first 2000 points until zoomed in, or render circles efficiently
            const RENDER_LIMIT = 2000;
            const renderSet = dataToRender.length > RENDER_LIMIT ? dataToRender.slice(0, RENDER_LIMIT) : dataToRender;

            if(dataToRender.length > RENDER_LIMIT) {
                cardDetail.innerHTML = `<span class="text-amber-300">Showing 2000 of ${dataToRender.length} outlets. Filter to see specific data.</span>`;
            }

            renderSet.forEach(data => {
                const marker = L.circleMarker([data.lat, data.lng], {
                    radius: 5,
                    fillColor: "#E01933", 
                    color: "#FFFFFF",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(markerLayer);

                marker.bindPopup(`<div style="color:#E01933; font-weight:bold; font-size:12px">${data.outletName}</div><div style="font-size:10px; color:#666">${data.route}</div>`);
                
                marker.on('click', () => {
                    let detailHtml = `<span class="opacity-75">Outlet:</span> <b>${data.outletName}</b>`;
                    if(data.route) detailHtml += `<br><span class="opacity-75">Route:</span> <b>${data.route}</b>`;
                    cardTitle.textContent = "Outlet Details";
                    cardDetail.innerHTML = detailHtml;
                });
            });

            // Route Lines - Calculation logic (only calculate if filtered to manageable number)
            if (dataToRender.length < 500) {
                const routeGroups = {};
                dataToRender.forEach(item => {
                    const routeName = item.route || 'Unassigned';
                    if (!routeGroups[routeName]) routeGroups[routeName] = [];
                    routeGroups[routeName].push(item);
                });

                let totalMeters = 0;

                Object.entries(routeGroups).forEach(([route, items]) => {
                    if (items.length < 2) return;

                    let remaining = [...items].reverse(); 
                    const sortedGeoItems = [remaining.shift()]; 
                    
                    while (remaining.length > 0) {
                        const lastItem = sortedGeoItems[sortedGeoItems.length - 1];
                        const lastLatLng = L.latLng(lastItem.lat, lastItem.lng);
                        let nearestIndex = -1;
                        let minDistance = Infinity;

                        remaining.forEach((item, index) => {
                            const dist = lastLatLng.distanceTo(L.latLng(item.lat, item.lng));
                            if (dist < minDistance) {
                                minDistance = dist;
                                nearestIndex = index;
                            }
                        });

                        totalMeters += minDistance;
                        sortedGeoItems.push(remaining[nearestIndex]);
                        remaining.splice(nearestIndex, 1);
                    }

                    const latlngs = sortedGeoItems.map(d => [d.lat, d.lng]);

                    if (latlngs.length > 1) {
                        L.polyline(latlngs, {
                            color: '#002169', 
                            weight: 2,
                            opacity: 0.5,
                            dashArray: '4, 4', 
                            lineJoin: 'round'
                        }).addTo(polylineLayer).bindPopup(`Route: ${route}`);
                    }
                });

                const totalKm = (totalMeters / 1000).toFixed(1);
                kpiDistance.innerHTML = `${totalKm} <span class="text-xs font-semibold text-gray-400">km</span>`;
            } else {
                kpiDistance.innerHTML = `- <span class="text-xs font-semibold text-gray-400">km</span>`;
            }

            if (renderSet.length > 0 && renderSet.length < 5000) {
                try {
                    map.fitBounds(markerLayer.getBounds(), { padding: [20, 20], maxZoom: 14 });
                } catch (e) { }
            }
        };

        const renderInvalidList = (dataList) => {
            invalidList.innerHTML = ''; 
            
            if (dataList.length > 0) {
                invalidBox.classList.remove('hidden');
                invalidHeader.textContent = `Data Anomalies (${dataList.length})`;
                
                // Only render first 100 errors to prevent lag
                const displayList = dataList.slice(0, 100);
                
                displayList.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'invalid-list-item flex-shrink-0 w-64 bg-red-50 p-2 rounded border border-red-100 text-[10px] text-gray-600';
                    item.innerHTML = `
                        <div class="font-bold text-gray-800 truncate">${data.outletName}</div>
                        <div class="flex justify-between mt-1">
                            <span>Route: ${data.route}</span>
                            <span class="font-mono text-red-500">${data.lat.toFixed(2)}, ${data.lng.toFixed(2)}</span>
                        </div>
                    `;
                    invalidList.appendChild(item);
                });
            } else {
                invalidBox.classList.add('hidden');
            }
        };

        const clearFilters = () => {
            searchInput.value = "";
            filterArea.value = "";
            filterTerritory.value = "";
            filterTown.value = "";
            selectedRoutes.clear();
            routeBtnText.textContent = "All Routes";
            // Uncheck checkboxes visually
            document.querySelectorAll('.route-checkbox').forEach(cb => cb.checked = false);
            
            updateCascadingFilters(0); 
        };

        const parseCsv = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return { success: false, message: "CSV empty" };

            const rawHeaders = lines[0].trim().replace(/^\uFEFF/, '').split(',').map(h => h.trim());
            
            const FIELD_MAPPINGS = {
                lat: ['Outlet Latitude', 'Latitude', 'lat'],
                lng: ['Outlet Longitude', 'Longitude', 'lng'],
                route: ['Route Name', 'route'],
                outletName: ['Outlet Name', 'outletName']
            };

            const detectedHeaders = {};
            for (const [key, aliases] of Object.entries(FIELD_MAPPINGS)) {
                const found = aliases.find(alias => rawHeaders.includes(alias));
                if (found) {
                    detectedHeaders[key] = found;
                } else {
                    return { success: false, message: `Missing: ${aliases.join(' or ')}` };
                }
            }
            
            const data = [];
            // Parse CSV Loop
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].trim().split(',');
                if (values.length < rawHeaders.length) continue; 

                const rawRecord = {};
                rawHeaders.forEach((header, index) => {
                    rawRecord[header] = values[index] ? values[index].trim() : '';
                });

                const record = {
                    lat: parseFloat(rawRecord[detectedHeaders.lat]),
                    lng: parseFloat(rawRecord[detectedHeaders.lng]),
                    route: rawRecord[detectedHeaders.route],
                    outletName: rawRecord[detectedHeaders.outletName],
                    timestamp: new Date().toISOString()
                };

                for (const header of rawHeaders) {
                    const isMapped = Object.values(detectedHeaders).includes(header);
                    if (!isMapped) {
                        const key = header.toLowerCase().replace(/\s+/g, '_');
                        record[key] = rawRecord[header];
                    }
                }

                if (isNaN(record.lat) || isNaN(record.lng) || !record.route || !record.outletName) continue;
                data.push(record);
            }
            return { success: true, data: data };
        };

        const handleCsvUpload = async () => {
            const file = csvUpload.files[0];
            if (!file) return;

            uploadCsvBtn.disabled = true;
            uploadStatus.textContent = "Parsing...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                const parseResult = parseCsv(e.target.result);

                if (!parseResult.success) {
                    uploadStatus.textContent = parseResult.message;
                    uploadCsvBtn.disabled = false;
                    return;
                }
                
                uploadStatus.textContent = `Saving ${parseResult.data.length.toLocaleString()} records...`;
                
                // Save to IndexedDB
                try {
                    await saveDataToIDB(parseResult.data);
                    
                    // Reload data from DB to memory to refresh UI
                    await loadData();
                    
                    uploadStatus.textContent = "Upload Complete!";
                    csvUpload.value = '';
                    fileNameDisplay.classList.add('hidden');
                    setTimeout(() => { 
                        uploadStatus.textContent = "Req: Lat, Lng, Route, Outlet Name"; 
                        uploadCsvBtn.disabled = false;
                    }, 2000);
                } catch (e) {
                    console.error(e);
                    uploadStatus.textContent = "Save Failed (DB Error)";
                    uploadCsvBtn.disabled = false;
                }
            };
            reader.readAsText(file);
        };
        
        csvUpload.addEventListener('change', () => {
            if (csvUpload.files.length > 0) {
                uploadCsvBtn.disabled = false;
                fileNameDisplay.textContent = csvUpload.files[0].name;
                fileNameDisplay.classList.remove('hidden');
                uploadStatus.textContent = "Ready to upload";
            }
        });

        uploadCsvBtn.addEventListener('click', handleCsvUpload);

        searchInput.addEventListener('input', applyLocalFilters);
        
        filterArea.addEventListener('change', () => updateCascadingFilters(0));
        filterTerritory.addEventListener('change', () => updateCascadingFilters(1));
        filterTown.addEventListener('change', () => updateCascadingFilters(2));
        
        routeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            routeList.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!routeBtn.contains(e.target) && !routeList.contains(e.target)) {
                routeList.classList.add('hidden');
            }
        });
        
        clearFiltersBtn.addEventListener('click', clearFilters);
        clearDataBtn.addEventListener('click', clearAllData);

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
